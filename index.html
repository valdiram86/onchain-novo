<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel RSI ‚Äì WebApp Oficial</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      text-align: center;
    }
    input, select, button {
      font-size: 16px;
      padding: 8px;
      margin: 5px;
    }
    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 95%;
      background: #fff;
    }
    th, td {
      padding: 6px 10px;
      border: 1px solid #ccc;
    }
    th {
      background: #eee;
      cursor: pointer;
    }
    .success { color: green; }
    .error { color: red; }
    .highlight { background-color: #e0ffe0; }
    .green { background-color: #d6ffd6; }
    .strong-green { background-color: #90ee90; }
  </style>
</head>
<body>

  <h2>Painel RSI ‚Äì WebApp Oficial</h2>

  <p>Digite seu e-mail autorizado:</p>
  <input type="email" id="email" placeholder="seu@email.com" size="35">
  <button onclick="verificarEmail()">Entrar</button>

  <p id="msg" class="error"></p>

  <div id="painel" style="display:none;">
    <p class="success">‚úÖ Acesso autorizado.</p>

    <label>Selecionar aba: </label>
    <select id="aba">
      <option>OndaDeAlta_5</option>
      <option>OndaDeAlta_7_5</option>
      <option>OndaDeAlta_10</option>
    </select>
    <button onclick="carregarDados()">Testar Aba Manualmente</button>
    <button onclick="exportarCSV()">Exportar CSV</button>
    <p id="contador"></p>

    <table>
      <thead id="cabecalho"></thead>
      <tbody id="dados"></tbody>
    </table>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzwymz6vAO9ns6pRZaWSshId2XaCjt7EuFH4-nfvTuw5avtJzzFmbTqS6IllwURJM9ktw/exec";
    let dadosOriginais = [];

    function verificarEmail() {
      const email = document.getElementById("email").value.trim();
      if (!email) return alert("Informe o e-mail.");

      fetch(`${SCRIPT_URL}?email=${email}`)
        .then(r => r.text())
        .then(res => {
          const msg = document.getElementById("msg");
          if (res.includes("‚úÖ")) {
            msg.innerHTML = "‚úÖ Acesso autorizado.";
            msg.className = "success";
            document.getElementById("painel").style.display = "block";
            carregarDados(); // Carrega ao autorizar
          } else {
            msg.innerHTML = res;
            msg.className = "error";
          }
        })
        .catch(() => {
          document.getElementById("msg").innerHTML = "Erro de conex√£o.";
        });
    }

    function carregarDados() {
      const aba = document.getElementById("aba").value;
      fetch(`${SCRIPT_URL}?aba=${aba}`)
        .then(r => r.json())
        .then(dados => {
          dadosOriginais = dados;
          montarTabela(dados);
          document.getElementById("contador").innerHTML = `‚úÖ ${dados.length} linhas carregadas da aba ${aba}.`;
        })
        .catch(() => {
          document.getElementById("contador").innerHTML = "‚ùå Erro ao carregar dados.";
        });
    }

    function montarTabela(dados) {
      const cab = document.getElementById("cabecalho");
      const corpo = document.getElementById("dados");
      const colunas = ["Ranking", "S√≠mbolo", "Link", "RSI (1D)", "Varia√ß√£o 1D (%)", "Volume (24h)", "Market Cap"];

      cab.innerHTML = "<tr>" + colunas.map((c, i) => `<th onclick="ordenarPor(${i})">${c}</th>`).join("") + "</tr>";
      corpo.innerHTML = "";

      dados.forEach(l => {
        const tr = document.createElement("tr");
        colunas.forEach((_, i) => {
          const td = document.createElement("td");
          let v = l[i];
          if (i === 2) {
            td.innerHTML = `<a href="${v}" target="_blank">üîó</a>`;
          } else {
            td.textContent = v;
          }

          if (i === 4 && !isNaN(v)) {
            if (v >= 30) td.className = "strong-green";
            else if (v >= 10) td.className = "green";
          }

          tr.appendChild(td);
        });
        corpo.appendChild(tr);
      });
    }

    function ordenarPor(indice) {
      const ordenado = [...dadosOriginais].sort((a, b) => {
        const valA = a[indice];
        const valB = b[indice];
        return (typeof valA === "number" && typeof valB === "number") 
          ? valB - valA : String(valA).localeCompare(String(valB));
      });
      montarTabela(ordenado);
    }

    function exportarCSV() {
      if (!dadosOriginais.length) return alert("Nada para exportar.");
      const linhas = dadosOriginais.map(l => l.join(","));
      const csv = linhas.join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "dados.csv";
      link.click();
    }
  </script>

</body>
</html>
